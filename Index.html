<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Formula Calculator</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2ecc71" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .card {
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 460px;
      text-align: center;
    }
    h1 { font-size: 1.4rem; margin-bottom: 10px; }
    .formula {
      font-family: monospace;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 6px;
      margin: 12px 0;
    }
    .row { margin-bottom: 10px; }
    input {
      padding: 6px;
      font-size: 0.95rem;
      width: 120px;
    }
    .time { color: #555; margin-bottom: 6px; }
    .result { font-size: 1.3rem; font-weight: bold; margin-top: 12px; }
    .warning { color: #c0392b; font-size: 0.9rem; margin-top: 8px; }
    .buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 14px;
    }
    button {
      padding: 8px 14px;
      font-size: 0.9rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .pause { background: #f1c40f; }
    .resume { background: #2ecc71; }
    .reset { background: #e74c3c; color: #fff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Fully Custom Formula Calculator</h1>

    <div class="formula" id="formula"></div>

    <div class="row">
      <div class="time">Formula parameters:</div>
      a · n / (K − n) + b
    </div>

    <div class="row">
      a = <input type="number" id="aValue" value="1" step="0.1"> &nbsp;
      K = <input type="number" id="kValue" value="100" min="1"> &nbsp;
      b = <input type="number" id="bValue" value="0" step="0.1">
    </div>

    <div class="row">
      <div class="time">Start counting from clock time:</div>
      <input type="time" id="startClock" />
    </div>

    <div class="time" id="minutes">Minutes passed: 0.00</div>
    <div class="result" id="result">Result: —</div>
    <div class="warning" id="warning"></div>

    <div class="buttons">
      <button class="pause" id="pauseBtn">Pause</button>
      <button class="resume" id="resumeBtn" disabled>Resume</button>
      <button class="reset" id="resetBtn">Reset</button>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const minutesEl = document.getElementById('minutes');
    const resultEl = document.getElementById('result');
    const warningEl = document.getElementById('warning');
    const formulaEl = document.getElementById('formula');

    const startClockInput = document.getElementById('startClock');
    const aInput = document.getElementById('aValue');
    const kInput = document.getElementById('kValue');
    const bInput = document.getElementById('bValue');

    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const resetBtn = document.getElementById('resetBtn');

    let startTime = Date.now();
    let pausedAt = null;
    let totalPausedTime = 0;
    let paused = false;

    function updateFormula() {
      const a = Number(aInput.value);
      const K = Number(kInput.value);
      const b = Number(bInput.value);
      formulaEl.textContent = `f(n) = ${a} · n / (${K} − n) + ${b}`;
    }

    [aInput, kInput, bInput].forEach(i => i.addEventListener('input', updateFormula));
    updateFormula();

    function setStartFromClock() {
      const value = startClockInput.value;
      if (!value) return;

      const [hours, minutes] = value.split(':').map(Number);
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0);

      startTime = start.getTime();
      totalPausedTime = 0;
      paused = false;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      warningEl.textContent = '';
      update();
    }

    startClockInput.addEventListener('change', setStartFromClock);

    function getElapsedMinutes() {
      return (Date.now() - startTime - totalPausedTime) / 60000;
    }

    function update() {
      if (paused) return;

      const a = Number(aInput.value);
      const K = Number(kInput.value);
      const b = Number(bInput.value);
      const n = getElapsedMinutes();

      minutesEl.textContent = `Minutes passed: ${n.toFixed(2)}`;

      if (n < 0) {
        resultEl.textContent = 'Result: —';
        warningEl.textContent = 'Waiting for start time…';
        return;
      }

      if (n >= K) {
        resultEl.textContent = 'Result: —';
        warningEl.textContent = `Calculation stopped (n ≥ ${K})`;
        return;
      }

      warningEl.textContent = '';
      const value = a * n / (K - n) + b;
      resultEl.textContent = `Result: ${value.toFixed(6)}`;}`;
    }

    // Save & restore state
    function saveState() {
      localStorage.setItem('formulaState', JSON.stringify({
        a: aInput.value,
        K: kInput.value,
        b: bInput.value,
        startTime,
        totalPausedTime,
        paused
      }));
    }

    function loadState() {
      const state = JSON.parse(localStorage.getItem('formulaState'));
      if (!state) return;
      aInput.value = state.a;
      kInput.value = state.K;
      bInput.value = state.b;
      startTime = state.startTime;
      totalPausedTime = state.totalPausedTime;
      paused = state.paused;
      resumeBtn.disabled = !paused;
      pauseBtn.disabled = paused;
      updateFormula();
    }

    [aInput, kInput, bInput].forEach(i => i.addEventListener('input', saveState));

    setInterval(() => {
      update();
      saveState();
    }, 1000);

    loadState();
    update();

    pauseBtn.onclick = () => {
      if (paused) return;
      paused = true;
      pausedAt = Date.now();
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
    };

    resumeBtn.onclick = () => {
      if (!paused) return;
      paused = false;
      totalPausedTime += Date.now() - pausedAt;
      pausedAt = null;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      update();
    };

    resetBtn.onclick = () => {
      startTime = Date.now();
      totalPausedTime = 0;
      pausedAt = null;
      paused = false;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      startClockInput.value = '';
      warningEl.textContent = '';
      update();
    };

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) update();
    });
  </script>
</body>
</html>
